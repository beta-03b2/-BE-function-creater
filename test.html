<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minecraft BE ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ãƒ¼ãƒ‘ãƒƒã‚¯ Functionãƒ¡ãƒ¼ã‚«ãƒ¼</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
:root { --gap:12px; --radius:10px; }
* { box-sizing:border-box; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif; margin:0; padding:24px; background:#0e0f12; color:#e7e9ee; }
h1 { font-size:1.4rem; margin:0 0 10px; }
.app { max-width:980px; margin:0 auto; display:grid; gap:var(--gap); }
.card { background:#16181d; border:1px solid #2a2f39; border-radius:var(--radius); padding:16px; }
label { display:block; font-weight:600; margin-bottom:6px; }
input[type="text"], textarea { width:100%; background:#0f1115; color:#e7e9ee; border:1px solid #2a2f39; border-radius:8px; padding:10px 12px; outline:none; }
textarea { min-height:110px; resize:vertical; line-height:1.35; }
input[type="file"] { display:block; }
.row { display:grid; gap:var(--gap); grid-template-columns:1fr; }
@media (min-width: 880px) { .row.two { grid-template-columns: 1fr 1fr; } }
.hint { font-size:.9rem; color:#98a2b3; }
.req::after { content:" *"; color:#ff6b6b; }
.btn { border:1px solid #2a2f39; background:#1b1f28; color:#e7e9ee; padding:10px 14px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
.btn:hover { background:#222734; }
.btn.primary { background:#2a6ef7; border-color:#2a6ef7; }
.btn.primary:hover { filter:brightness(1.1); }
.btn.ghost { background:transparent; }
.btn.icon { padding:8px; border-radius:6px; }
.toolbar { display:flex; gap:10px; flex-wrap:wrap; }
.functions { display:grid; gap:10px; }
.func-item { border:1px solid #2a2f39; border-radius:10px; padding:12px; background:#0f1115; display:grid; gap:8px; }
.func-head { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.func-name { font-weight:700; word-break:break-all; }
.icons { display:flex; gap:6px; }
.badge { background:#2a2f39; padding:2px 8px; border-radius:999px; font-size:.8rem; }
.error { color:#ff6b6b; font-weight:700; }
.success { color:#4ade80; font-weight:700; }
.list-empty { color:#98a2b3; }
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Mono", monospace; }
.spacer { height:6px; }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ãƒ¼ãƒ‘ãƒƒã‚¯ Function ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆ.mcaddon å‡ºåŠ›ï¼‰</h1>
      <div class="hint">ã‚¿ã‚¤ãƒˆãƒ«ã¨ functionï¼ˆ1ã¤ä»¥ä¸Šï¼‰ã¯å¿…é ˆã§ã™ã€‚ç”»åƒã¨èª¬æ˜ã¯ä»»æ„ã§ã™ã€‚</div>
    </header>

    <!-- ãƒ‘ãƒƒã‚¯æƒ…å ± -->
    <section class="card">
      <div class="row two">
        <div>
          <label class="req">ãƒ‘ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="packTitle" placeholder="ä¾‹ï¼‰My Function Pack" />
        </div>
        <div>
          <label>èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="packDesc" placeholder="ä¾‹ï¼‰ã‚³ãƒãƒ³ãƒ‰è‡ªå‹•åŒ–ç”¨ã®é–¢æ•°é›†" />
          <div class="hint">manifest.json ã® description ã«å…¥ã‚Šã¾ã™</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="row two">
        <div>
          <label>ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒï¼ˆä»»æ„ï¼‰</label>
          <input type="file" id="packIcon" accept="image/*" />
          <div class="hint">å…¥ã‚Œã‚‹ã¨ <code class="mono">pack_icon.png</code> ã¨ã—ã¦åŒæ¢±ã•ã‚Œã¾ã™ï¼ˆæ¨å¥¨ 256Ã—256ï¼‰</div>
        </div>
        <div>
          <label>ãƒ‘ãƒƒã‚¯ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
          <input type="text" id="packVersion" value="1.0.0" />
        </div>
      </div>
    </section>

    <!-- functionä½œæˆ -->
    <section class="card">
      <h2 style="margin-top:0">function ã®ä½œæˆ</h2>
      <div class="row">
        <div>
          <label class="req">ã‚³ãƒãƒ³ãƒ‰åï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰</label>
          <input type="text" id="funcName" placeholder="ä¾‹ï¼‰reset" />
        </div>
        <div>
          <label class="req">ã‚³ãƒãƒ³ãƒ‰å†…å®¹ï¼ˆ1è¡Œã«1ã‚³ãƒãƒ³ãƒ‰ï¼‰</label>
          <textarea id="funcBody" placeholder="clear @a&#10;tp @a 0 0 0&#10;gamemode a @a"></textarea>
        </div>
        <div class="toolbar">
          <button class="btn" id="addFuncBtn">ï¼‹ è¿½åŠ </button>
          <span id="funcMsg"></span>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="functions" id="funcList">
        <div class="list-empty">ã¾ã  function ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </section>

    <!-- å‡ºåŠ› -->
    <section class="card">
      <div class="toolbar">
        <button class="btn primary" id="exportBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆ.mcaddon ã‚’ä½œæˆï¼‰</button>
      </div>
      <div id="exportMsg" class="hint" style="margin-top:8px;"></div>
    </section>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const sanitizeName = s => (s||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-\.]/g,"_");
const parseVersion = v => (v||"1.0.0").split(".").map(n=>parseInt(n)||0);
const uuidv4 = () => crypto.randomUUID ? crypto.randomUUID() :
  "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==="x"?r:(r&0x3|0x8);return v.toString(16);
  });

let functions = [];
let seq=0;
let editId=null;

const packTitleEl=$("#packTitle");
const packDescEl=$("#packDesc");
const packIconEl=$("#packIcon");
const packVersionEl=$("#packVersion");
const funcNameEl=$("#funcName");
const funcBodyEl=$("#funcBody");
const funcListEl=$("#funcList");
const funcMsgEl=$("#funcMsg");
const exportBtn=$("#exportBtn");
const exportMsg=$("#exportMsg");

$("#addFuncBtn").addEventListener("click",()=>{
  let name=sanitizeName(funcNameEl.value);
  let body=(funcBodyEl.value||"").trim();

  // 10000è¡Œåˆ¶é™
  let lineCount = body.split("\n").length;
  if(lineCount > 10000){
    showFuncMsg("é™ç•Œã§ã™ï¼ˆ10000è¡Œã¾ã§ï¼‰",true);
    return;
  }

  // /å‰Šé™¤
  body = body.split("\n").map(line=>line.replace(/^\/+/,"")).join("\n");

  if(!name){showFuncMsg("ã‚³ãƒãƒ³ãƒ‰åå¿…é ˆ",true);return;}
  if(!body){showFuncMsg("ã‚³ãƒãƒ³ãƒ‰å†…å®¹å¿…é ˆ",true);return;}

  if(editId !== null){
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    let idx = functions.findIndex(f => f.id === editId);
    if(idx > -1){
      functions[idx].name = name;
      functions[idx].body = body;
    }
    editId = null;
    $("#addFuncBtn").textContent = "ï¼‹ è¿½åŠ ";
    showFuncMsg(`æ›´æ–°: ${name}.mcfunction`,false);
  } else {
    // æ–°è¦è¿½åŠ 
    name=ensureUniqueName(name);
    functions.push({id:++seq,name,body});
    showFuncMsg(`è¿½åŠ : ${name}.mcfunction`,false);
  }
  
  funcNameEl.value=""; funcBodyEl.value="";
  renderFunctions();
});

function ensureUniqueName(name){
  let base=name.replace(/\.mcfunction$/i,"");
  let cand=base, i=2;
  while(functions.some(f=>f.name===cand)){cand=`${base}_${i++}`;}
  return cand;
}

function showFuncMsg(msg,err){funcMsgEl.textContent=msg;funcMsgEl.className=err?"error":"success";}

function renderFunctions(){
  funcListEl.innerHTML="";
  if(functions.length===0){
    funcListEl.innerHTML='<div class="list-empty">ã¾ã  function ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }
  functions.forEach(f=>{
    const div=document.createElement("div");
    div.className="func-item";
    div.innerHTML=`
      <div class="func-head">
        <span class="func-name">${f.name}.mcfunction</span>
        <div class="icons">
          <button class="btn" onclick="editFunction(${f.id})">ç·¨é›†</button>
          <button class="btn" onclick="deleteFunction(${f.id})">å‰Šé™¤</button>
        </div>
      </div>
      <pre class="mono">${f.body}</pre>`;
    funcListEl.appendChild(div);
  });
}

window.editFunction = function(id){
  let f = functions.find(x => x.id === id);
  if(!f) return;
  funcNameEl.value = f.name;
  funcBodyEl.value = f.body;
  editId = id;
  $("#addFuncBtn").textContent = "ä¿å­˜";
}

window.deleteFunction = function(id){
  functions = functions.filter(f => f.id !== id);
  renderFunctions();
}

function buildManifest(){
  const name=packTitleEl.value.trim();
  const desc=packDescEl.value.trim()||name;
  const version=parseVersion(packVersionEl.value);
  return {
    format_version:2,
    header:{name,description:desc,uuid:uuidv4(),version,min_engine_version:[1,20,0]},
    modules:[{type:"data",uuid:uuidv4(),version}]
  };
}

exportBtn.addEventListener("click", async()=>{
  exportMsg.textContent="";
  const title=packTitleEl.value.trim();
  if(!title){setExportMsg("ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ",true);return;}
  if(functions.length===0){setExportMsg("function å¿…é ˆ",true);return;}
  const safeTitle=sanitizeName(title)||"behavior_pack";
  const manifest=buildManifest();
  const zip=new JSZip();
  const bp=zip.folder(safeTitle);
  bp.file("manifest.json",JSON.stringify(manifest,null,2));
  const funcsDir=bp.folder("functions");
  functions.forEach(f=>funcsDir.file(`${f.name}.mcfunction`,f.body+"\n"));
  const iconFile=packIconEl.files&&packIconEl.files[0];
  if(iconFile){
    const buf=await fileToArrayBuffer(iconFile);
    bp.file("pack_icon.png",buf);
  }
  const fileName=`${safeTitle}.mcaddon`;

  if(/iPad|iPhone|iPod/.test(navigator.userAgent)){
    const base64=await zip.generateAsync({type:"base64"});
    const link=document.createElement("a");
    link.href="data:application/zip;base64,"+base64;
    link.download=fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setExportMsg(`iOSç”¨ã« ${fileName} ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`,false);
  } else {
    const blob=await zip.generateAsync({type:"blob"});
    saveAs(blob,fileName);
    setExportMsg(`${fileName} ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`,false);
  }
});

function setExportMsg(msg,err){exportMsg.textContent=msg;exportMsg.className=err?"error":"success";}
function fileToArrayBuffer(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsArrayBuffer(file);
  });
}
</script>
</body>
</html>

<style>
    /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
    #menuButton {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 30px;
      cursor: pointer;
      z-index: 1001;
    }

    /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #sideMenu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background-color: #333;
      color: white;
      transition: left 0.3s;
      z-index: 1000;
    }

    #sideMenu.open {
      left: 0;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›® */
    #sideMenu ul {
      list-style-type: none;
      padding: 0;
    }

    #sideMenu li {
      padding: 10px;
      cursor: pointer;
    }

    #sideMenu li:hover {
      background-color: #444;
    }

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }
  </style>


  <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div id="menuButton">&#9776; ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

  <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="sideMenu">
    <ul id="packList">
      <!-- ãƒ‘ãƒƒã‚¯ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
    </ul>
    <button onclick="newPack()">æ–°è¦ä½œæˆ</button>
  </div>

  <script>
    let currentPackId = null;
    let db;

    // IndexedDB åˆæœŸåŒ–
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("BEFunctionPacks", 1);
        request.onupgradeneeded = e => {
          db = e.target.result;
          if (!db.objectStoreNames.contains("packs")) {
            db.createObjectStore("packs", { keyPath: "id" });
          }
        };
        request.onsuccess = e => {
          db = e.target.result;
          resolve();
        };
        request.onerror = reject;
      });
    }

    // ä¿å­˜
    function saveCurrentPack() {
      if (!currentPackId) currentPackId = Date.now().toString();
      const data = {
        id: currentPackId,
        title: document.querySelector("#titleInput").value,
        description: document.querySelector("#descriptionInput").value,
        version: document.querySelector("#versionInput").value,
        funcName: document.querySelector("#funcNameInput").value,
        functions: document.querySelector("#functionInput").value,
        updated: Date.now()
      };
      const tx = db.transaction("packs", "readwrite");
      tx.objectStore("packs").put(data);
      tx.oncomplete = loadPackList;
    }

    // ãƒ‘ãƒƒã‚¯ä¸€è¦§è¡¨ç¤º
    function loadPackList() {
      const tx = db.transaction("packs", "readonly");
      tx.objectStore("packs").getAll().onsuccess = e => {
        const list = document.getElementById("packList");
        list.innerHTML = "";
        e.target.result.sort((a,b)=>b.updated-a.updated).forEach(pack => {
          const li = document.createElement("li");
          const span = document.createElement("span");
          span.textContent = pack.title || "ç„¡é¡Œ";
          span.onclick = () => loadPack(pack.id);
          const del = document.createElement("button");
          del.textContent = "ğŸ—‘";
          del.onclick = () => deletePack(pack.id);
          li.appendChild(span);
          li.appendChild(del);
          list.appendChild(li);
        });
      };
    }

    // ãƒ‘ãƒƒã‚¯èª­ã¿è¾¼ã¿
    function loadPack(id) {
      const tx = db.transaction("packs", "readonly");
      tx.objectStore("packs").get(id).onsuccess = e => {
        const pack = e.target.result;
        if (!pack) return;
        currentPackId = pack.id;
        document.querySelector("#titleInput").value = pack.title || "";
        document.querySelector("#descriptionInput").value = pack.description || "";
        document.querySelector("#versionInput").value = pack.version || "";
        document.querySelector("#funcNameInput").value = pack.funcName || "";
        document.querySelector("#functionInput").value = pack.functions || "";
      };
    }

    // æ–°è¦ä½œæˆ
    function newPack() {
      currentPackId = Date.now().toString();
      ["#titleInput","#descriptionInput","#versionInput","#funcNameInput","#functionInput"].forEach(sel=>{
        const el = document.querySelector(sel);
        if(el) el.value="";
      });
      saveCurrentPack();
    }

    // å‰Šé™¤
    function deletePack(id) {
      const tx = db.transaction("packs","readwrite");
      tx.objectStore("packs").delete(id).oncomplete = loadPackList;
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
    const menu = document.getElementById("sideMenu");
    const button = document.getElementById("menuButton");
    button.onclick = ()=> menu.classList.toggle("open");
    document.addEventListener("click", e=>{
      if(menu.classList.contains("open") && !menu.contains(e.target) && !button.contains(e.target)){
        menu.classList.remove("open");
      }
    });

    // å…¥åŠ›ç›£è¦–ã§ä¿å­˜
    ["#titleInput","#descriptionInput","#versionInput","#funcNameInput","#functionInput"].forEach(sel=>{
      const el = document.querySelector(sel);
      if(el) el.addEventListener("input", saveCurrentPack);
    });

    // åˆæœŸåŒ–
    initDB().then(()=>{
      loadPackList();
      // æœ€çµ‚æ›´æ–°ãƒ‘ãƒƒã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰
      const tx = db.transaction("packs","readonly");
      tx.objectStore("packs").getAll().onsuccess = e=>{
        if(e.target.result.length>0){
          const latest = e.target.result.sort((a,b)=>b.updated-a.updated)[0];
          loadPack(latest.id);
        } else newPack();
      };
    });
  </script>