<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>BE Function Creator</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
input, textarea, button { margin: 5px 0; padding: 5px; }
.function-item { background: #fff; padding: 10px; margin: 5px 0; border: 1px solid #ccc; }
button { cursor: pointer; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

<h1>BE Function Creator</h1>
<label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰<br><input id="packTitle" placeholder="ãƒ‘ãƒƒã‚¯å"></label><br>
<label>èª¬æ˜ï¼ˆä»»æ„ï¼‰<br><textarea id="packDesc"></textarea></label><br>
<label>ç”»åƒï¼ˆä»»æ„ï¼‰<br><input type="file" id="packIcon" accept="image/*"></label><br>

<h2>Function ä½œæˆ</h2>
<label>ã‚³ãƒãƒ³ãƒ‰åï¼ˆå¿…é ˆï¼‰<br><input id="funcName" placeholder="ä¾‹) reset"></label><br>
<label>ã‚³ãƒãƒ³ãƒ‰å†…å®¹ï¼ˆå¿…é ˆï¼‰<br>
<textarea id="funcBody" placeholder="clear @a
tp @a 0 0 0
gamemode a @a"></textarea></label><br>
<button id="addFunc">è¿½åŠ </button>

<div id="functionsList"></div>

<hr>
<button id="exportBtn">.mcaddonä½œæˆ</button>
<p id="exportMsg"></p>

<script>
const packTitleEl = document.getElementById("packTitle");
const packDescEl = document.getElementById("packDesc");
const packIconEl = document.getElementById("packIcon");
const funcNameEl = document.getElementById("funcName");
const funcBodyEl = document.getElementById("funcBody");
const addFuncBtn = document.getElementById("addFunc");
const functionsListEl = document.getElementById("functionsList");
const exportBtn = document.getElementById("exportBtn");
const exportMsg = document.getElementById("exportMsg");

let functions = [];

function sanitizeName(name) {
  return name.replace(/[^a-zA-Z0-9_\-]/g, "_");
}

function setExportMsg(msg, isError) {
  exportMsg.style.color = isError ? "red" : "green";
  exportMsg.textContent = msg;
}

function renderFunctions() {
  functionsListEl.innerHTML = "";
  functions.forEach((f, index) => {
    const div = document.createElement("div");
    div.className = "function-item";
    div.innerHTML = `
      <b>${f.name}</b><br>
      <pre>${f.body}</pre>
      <button class="edit">âœ ç·¨é›†</button>
      <button class="delete">ğŸ—‘ å‰Šé™¤</button>
    `;
    div.querySelector(".edit").addEventListener("click", () => {
      funcNameEl.value = f.name;
      funcBodyEl.value = f.body;
      functions.splice(index, 1);
      renderFunctions();
    });
    div.querySelector(".delete").addEventListener("click", () => {
      functions.splice(index, 1);
      renderFunctions();
    });
    functionsListEl.appendChild(div);
  });
}

addFuncBtn.addEventListener("click", () => {
  const name = sanitizeName(funcNameEl.value.trim());
  let body = funcBodyEl.value.trim();

  if (!name || !body) {
    alert("ã‚³ãƒãƒ³ãƒ‰åã¨å†…å®¹ã¯å¿…é ˆã§ã™");
    return;
  }

  // å…ˆé ­ã® / ã‚’å‰Šé™¤
  body = body.split("\n").map(line => line.replace(/^\/+/, "")).join("\n");

  // 10000è¡Œåˆ¶é™
  const totalLines = functions.reduce((sum, f) => sum + f.body.split("\n").length, 0) + body.split("\n").length;
  if (totalLines > 10000) {
    alert("é™ç•Œã§ã™ï¼ˆ10000è¡Œã‚’è¶…ãˆã¦ã„ã¾ã™ï¼‰");
    return;
  }

  functions.push({ name, body });
  funcNameEl.value = "";
  funcBodyEl.value = "";
  renderFunctions();
});

function fileToArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function buildManifest() {
  return {
    manifest: {
      format_version: 2,
      header: {
        name: packTitleEl.value,
        description: packDescEl.value,
        uuid: crypto.randomUUID(),
        version: [1, 0, 0],
        min_engine_version: [1, 20, 0]
      },
      modules: [
        {
          type: "data",
          uuid: crypto.randomUUID(),
          version: [1, 0, 0]
        }
      ]
    }
  };
}

exportBtn.addEventListener("click", async () => {
  setExportMsg("", false);
  const title = (packTitleEl.value || "").trim();
  if (!title) { setExportMsg("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™ã€‚", true); return; }
  if (functions.length === 0) { setExportMsg("function ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚", true); return; }

  const safeTitle = sanitizeName(title) || "behavior_pack";
  const { manifest } = buildManifest();
  const zip = new JSZip();

  const bp = zip.folder(safeTitle);
  bp.file("manifest.json", JSON.stringify(manifest, null, 2));
  const funcsDir = bp.folder("functions");
  functions.forEach(f => funcsDir.file(`${f.name}.mcfunction`, f.body + "\n"));

  const iconFile = packIconEl.files && packIconEl.files[0];
  if (iconFile) {
    const buf = await fileToArrayBuffer(iconFile);
    bp.file("pack_icon.png", buf);
  }

  const fileName = `${safeTitle}.mcaddon`;

  if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
    const base64 = await zip.generateAsync({ type: "base64" });
    const link = document.createElement("a");
    link.href = "data:application/zip;base64," + base64;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setExportMsg(`iOSç”¨ã«Base64ãƒªãƒ³ã‚¯ã‹ã‚‰ ${fileName} ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, false);
  } else {
    const blob = await zip.generateAsync({ type: "blob" });
    saveAs(blob, fileName);
    setExportMsg(`.mcaddon ã‚’ä½œæˆã—ã¾ã—ãŸï¼š${fileName} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`, false);
  }
});
</script>

</body>
</html>
